
<?R
    tab = expand.grid(
        nu=c(1e-01, 0.1666666, 1e-02), 
        effdiam=c(14,28,56,112), 
        collision=c("CM_HIGHER")
    )

    dir_name <- "batch_IBB_PoiseuillePipe"
    dir.create(dir_name)
    tab$name = paste0("ibb_PoiseuillePipe_", tab$collision,"_nu_",tab$nu, "_effdiam_", tab$effdiam)
    # tab$xml = paste0(tab$name,".xml")
    tab$xml = paste0(paste0(dir_name,"/",tab$name),".xml")
    tab$output = paste0(paste0("output/",dir_name,"/",tab$name,"/"))
    #tab$output = paste0(paste0("/net/scratch/people/plgmuaddieb/output/",dir_name,"/",tab$name, "/"))

    tab$stl_path = paste0("WIP/Benchmarks/IBBPoiseuilleFlow3D/pipe_D", tab$effdiam,"_L127.stl")
    options(digits=10)
    write.csv(tab, "HotKarman3D_template.csv", row.names=FALSE)
    for (i in 1:nrow(tab)) {
        attach(tab[i,,drop=FALSE])
        print(xml)
        sink(xml) # save to a .xml file
?>

<?xml version="1.0"?>
<CLBConfig version="2.0" output="<?%s output ?>">
    <Geometry nx="127" ny="127"  nz="3" save="geometria_ibb">
        <<?%s collision ?>>
            <Box/>
        </<?%s collision ?>> 
        <FluxMeasurment> <Box nz="1"/> </FluxMeasurment>
        <Wall mask="ALL" name="border" >
            <STL file="<?%s stl_path ?>" scale="1" Xrot="0d" x="0" y="0" z="0" side="in"/>
        </Wall>

        <IBB name="border"  >
            <STL file="<?%s stl_path ?>" scale="1" Xrot="0d" x="0" y="0" z="0" side="surface"/>
        </IBB>


    </Geometry>
    <Model>
        <Params
            InitTemperature="10"
            InitTemperature-dirichlet_hot="11"
            InitTemperature-dirichlet_cold="10"
            />
        <Params/>

        <Params
            nu="<?%f nu ?>"
            nu_buffer="<?%f nu ?>"
            conductivity="0.1666666"

            h_stability_enhancement="1."
            cp="1."
            material_density="1."
            />
        <Params/>
	    <Params GravitationZ="<?%e 16.*0.01*nu/(effdiam * effdiam) ?>" />
	    <!-- <Params BoussinesqCoeff="1"/> -->
        <!-- gx = 4 * uz_max * nu / (rho * R * R) -->
        <!-- we set uz_max=0.01 - max velocity -->
    </Model>
<Failcheck Iterations="10000" nx="127" ny="127" nz="3" />
<!-- <TXT Iterations="50000" what="T,U"/> -->
<Solve Iterations="1"> <VTK Iterations="1"/> </Solve>
<Log Iterations="5000"/>
<Stop XHydroFLuxChange="1e-10" Times="6" Iterations="1000"/>
<Solve Iterations="10000000"><VTK Iterations="1000" what="T,U,Rho"/> </Solve>
<!-- <Solve Iterations="60000"> <VTK Iterations="20000" what="T,U,Rho"/> </Solve> -->
</CLBConfig>

<?R
    sink()
    detach()
}
?>
