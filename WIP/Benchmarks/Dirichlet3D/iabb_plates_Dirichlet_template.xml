
<?R
    tab = expand.grid(
        nu=c(1e-01), 
        #k_material=c(0.1666666, 1e-01, 1e-02, 1e-03, 1e-04, 1e-05),
        k_material=c(1e-01),

        #y=c(0.75, 1, 1.25),
        y=c(1),
        diam=c(15,31,63,127),

        collision=c("CM_HIGHER"),
        bb_type=c("abb")
    )

    dir_name <- "batch_IABB_plates"
    dir.create(dir_name)
    tab$name = paste0(tab$bb_type, "_plates_Dirichlet_", tab$collision,"_k_",tab$k_material, "_effdiam_", tab$diam-2*(2.-tab$y))
    tab$xml = paste0(paste0(dir_name,"/",tab$name),".xml")
    tab$output = paste0(paste0("output/",dir_name,"/",tab$name,"/"))
    #tab$output = paste0(paste0("/net/scratch/people/plgmuaddieb/output/",dir_name,"/",tab$name, "/"))

    options(digits=10)
    write.csv(tab, "HotKarman3D_template.csv", row.names=FALSE)
    for (i in 1:nrow(tab)) {
        attach(tab[i,,drop=FALSE])
        print(xml)
        sink(xml) # save to a .xml file
?>

<?xml version="1.0"?>
<CLBConfig version="2.0" output="<?%s output ?>">
    <Geometry nx="32" ny="<?%f diam ?>"  nz="3">
        <<?%s collision ?>>
            <Box/>
        </<?%s collision ?>>    
		<FluxMeasurment> <Box nx="1"/> </FluxMeasurment>
        <?R
        if(bb_type=="abb")
            {
                cat(sprintf("<HeaterDirichletTemperatureABB mask=\"COLLISION\" name=\"dirichlet_hot\">\n"))
                #cat(sprintf("\t\t<STL file=\"example/data/Plate_128x2x128.stl\" scale=\"1\" Xrot=\"0d\" x=\"-2\" y=\"%f\" z=\"-2\" side=\"in\" />\n",-y))
                cat(sprintf("\t\t<Box ny=\"1\" />\n"))
                cat(sprintf("\t</HeaterDirichletTemperatureABB>\n"))

                cat(sprintf("<HeaterDirichletTemperatureABB mask=\"COLLISION\" name=\"dirichlet_cold\">\n"))
                #cat(sprintf("\t\t<STL file=\"example/data/Plate_128x2x128.stl\" scale=\"1\" Xrot=\"0d\" x=\"-2\" y=\"%f\" z=\"-2\" side=\"in\" />\n", diam -(2.-y)))
                cat(sprintf("\t\t<Box dy=\"-1\" />\n"))
                cat(sprintf("\t</HeaterDirichletTemperatureABB>\n"))
            }
        else if(bb_type=="iabb")
            {
                cat(sprintf("<HeaterDirichletTemperatureIABB name=\"dirichlet_hot\">\n"))
                cat(sprintf("\t\t<STL file=\"example/data/Plate_128x2x128.stl\" scale=\"1\" Xrot=\"0d\" x=\"-2\" y=\"%f\" z=\"-2\" side=\"surface\" />\n", -y))
                cat(sprintf("\t</HeaterDirichletTemperatureIABB>\n"))

                cat(sprintf("<HeaterDirichletTemperatureIABB name=\"dirichlet_cold\">\n"))
                cat(sprintf("\t\t<STL file=\"example/data/Plate_128x2x128.stl\" scale=\"1\" Xrot=\"0d\" x=\"-2\" y=\"%f\" z=\"-2\" side=\"surface\" />\n", diam -(2.-y) ))
                cat(sprintf("\t</HeaterDirichletTemperatureIABB>\n"))	
            }
        else if(bb_type=="eq")
            {
                cat(sprintf("<HeaterDirichletTemperatureEQ name=\"dirichlet_hot\">\n"))
                cat(sprintf("\t\t<Box ny=\"1\" />\n"))
                cat(sprintf("\t</HeaterDirichletTemperatureEQ>\n"))

                cat(sprintf("<HeaterDirichletTemperatureEQ name=\"dirichlet_cold\">\n"))
                cat(sprintf("\t\t<Box dy=\"-1\" />\n"))
                cat(sprintf("\t</HeaterDirichletTemperatureEQ>\n"))   
            }
        ?>

		<!-- <Wall mask="ALL" name="border" >
	        <Box ny="1"/>
	        <Box dy="-1"/>
	    </Wall> -->

    </Geometry>

    <Model>
        <Params
            InitTemperature="10.5"
            InitTemperature-dirichlet_hot="11"
            InitTemperature-dirichlet_cold="10"
            />
        <Params/>

        <Params
            nu="<?%f nu ?>"
            conductivity="<?%f k_material ?>"

            h_stability_enhancement="1."
            cp="1"
            material_density="1"
            />
        <Params/>
	    <!-- <Params GravitationX="<?%e 2*0.01*nu/(0.25*(diam - 2.*(2.-y))*(diam - 2.*(2.-y))) ?>" /> -->
	    <!-- <Params BoussinesqCoeff="1"/> -->
        <!-- gx = 2 * uc * (mu_l + mu_h) / ((rho_l + rho_h) * h * h) -->
        <!-- we set uc=0.01 - max velocity -->
    </Model>
<Failcheck Iterations="5000" nx="32" ny="<?%f diam ?>" nz="3" />
<Solve Iterations="1"> <VTK Iterations="1"/> </Solve>
<Log Iterations="5000"/>

<Solve Iterations="1"> <VTK Iterations="1"/> </Solve>
<!-- <Solve Iterations="500000"></Solve>
<Stop XHydroFLuxChange="1e-11" Times="5" Iterations="10000"/> -->
<Solve Iterations="500000"><VTK Iterations="50000" what="T,U,Rho"/> </Solve>
</CLBConfig>

<?R
    sink()
    detach()
}
?>
