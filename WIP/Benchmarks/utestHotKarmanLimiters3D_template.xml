
<?R
    tab = expand.grid(
	    nu=c(1e-03), 
	    k=c(1e-03), 
	    sizer=c(0.5), 
	    Re=c(1000,10), 
	    collision=c("CM_HIGHER", "Cumulants_Higher", "Cumulants"), 
	    outlet=c("ENeumann","EConvect"),
	    is_nu_limiter=c(T),
	    is_k_limiter=c(T)
    )

    dir_name <- "batch_HotKarmanLimiters3D"
    dir.create(dir_name)
    # tab$name = paste0(dir_name,"/HotKarmanLimiters3D_template", "_nu_",tab$nu,"_k_",tab$k)
    # tab$xml = paste0(tab$name,".xml")

    tab$name = paste0("HotKarmanLimiters3D_template_",tab$collision, "_",tab$outlet, "_Re_",tab$Re, "_sizer_", tab$sizer, "_nu_",tab$nu, "_isnulim_", tab$is_nu_limiter, "_k_",tab$k, "_isklim_", tab$is_k_limiter )

    tab$xml = paste0(paste0(dir_name,"/",tab$name),".xml")

    tab$output = paste0(paste0("output/",dir_name,"/",tab$name,"/")) # set local output path
    # tab$output = paste0(paste0("/net/scratch/people/plgmuaddieb/output/",dir_name,"/",tab$name, "/")) # set path to $SCRATCH partition on HPC cluster

    write.csv(tab, "HotKarmanLimiters3D_template.csv", row.names=FALSE)
    for (i in 1:nrow(tab)) {
        attach(tab[i,,drop=FALSE])
        print(xml)
        sink(xml) # save to a .xml file
?>

<?xml version="1.0"?>
<CLBConfig version="2.0" output="output/">
    <Geometry nx="<?%f 1000*sizer ?>" ny="<?%f 150*sizer ?>" nz="3" >   
      <<?%s collision ?>> <Box/> </<?%s collision ?>>  
        <WVelocity><Inlet/></WVelocity>
      <<?%s outlet ?>> <Outlet/> </<?%s outlet ?>>  
        <Wall mask="ALL">
            <!-- <Channel/> -->
          <Cylinder dx="<?%f 285*sizer ?>" dy="<?%f 60*sizer ?>" nx="<?%f 30*sizer ?>" ny="<?%f 30*sizer ?>" nz="<?%f 50*sizer ?>"/>
        </Wall>

        <HeaterDirichletTemperatureEQ mask="COLLISION" name="dirichlet_hot"> 
          <Cylinder dx="<?%f 285*sizer ?>" dy="<?%f 60*sizer ?>" nx="<?%f 30*sizer ?>" ny="<?%f 30*sizer ?>" nz="<?%f 50*sizer ?>"/>
        </HeaterDirichletTemperatureEQ>  

        <ForceMeasurment>
            <Cylinder dx="<?%f 285*sizer ?>" dy="<?%f 60*sizer ?>" nx="<?%f 30*sizer ?>" ny="<?%f 30*sizer ?>" nz="<?%f 50*sizer ?>"/>
        </ForceMeasurment>

        <FluxMeasurment> <Box dx="-10" nx="1"/> </FluxMeasurment>
    </Geometry>

    <Model>
        <Params
            InitTemperature="10"
            InitTemperature-dirichlet_hot="11"
            InitTemperature-dirichlet_cold="10"
            />
        <Params/>

        <Params
            nu="<?%f nu ?>"
            conductivity="<?%f k ?>"

            h_stability_enhancement="1."
            cp="1"
            material_density="1"
            />
        <Params/>

        <?R
        if(!is_nu_limiter)
			{
			cat(sprintf("<Params nu_buffer=\"%f\" />\n", nu))
			#cat(sprintf("x=%.2f\n", nu))
			}
		?>
		<?R
        if(!is_k_limiter)
			{
			cat(sprintf("<Params conductivity_buffer=\"%f\" />\n", nu))
			}
		?>
        <Params VelocityX="<?%f Re*nu/(30*sizer) ?>" />
        <!-- <Params VelocityX="1.0E-02" /> -->
    </Model>


<Solve Iterations="5000"> 
	<Failcheck Iterations="1000" nx="<?%f 1000*sizer ?>" ny="<?%f 150*sizer ?>" nz="3" />
	<Log Iterations="1000"/>
	<VTK Iterations="10"/> 
</Solve>
</CLBConfig>

<?R
    sink()
    detach()
}
?>
